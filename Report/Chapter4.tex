% Copyright (c) 2015 Benito Palacios Sánchez - All Rights Reserved.
% Esta obra está licenciada bajo la Licencia Creative Commons Atribución 4.0
% Internacional. Para ver una copia de esta licencia, visita
% http://creativecommons.org/licenses/by/4.0/.

\chapter{Seguridad y derechos de autor}

A día de hoy uno de las principales preocupaciones de la industria respecto a la difusión de su obra se centra en los derechos de autor.
Esto es especialmente notable en el mundo de los videojuegos acosado por una piratería continua que causa pérdidas millonarias de dinero\footnote{\url{http://drm.web.unc.edu/games}}.
De este contexto nace la idea del \ac{DRM}.
Se trata en un mecanismo con el único fin de imposibilitar la distribución no autorizada de contenido.
Existe mecanismos desde los más sencillos y antiguos como son las claves que vienen impresas en un CD a los más nuevos que incluyen el cifrado del videojuego con datos personales de la cuenta del usuario\footnote{\url{http://www.darthnull.org/2014/10/06/ios-encryption}} o una conexión necesaria a los servidores de las compañía.
Las características comunes de estas técnicas se pueden resumir en los siguientes puntos\footnote{\url{http://es.wikipedia.org/wiki/Gestión_digital_de_derechos}}.

\begin{itemize}
    \item Detectar quién accede a cada obra, cuándo y bajo qué condiciones.
    \item Autorizar o denegar de manera inapelable el acceso a la obra.
    \item Autorizan el acceso bajo condiciones restrictivas.
\end{itemize}

Estos mecanismos a nivel general se basan en \textit{software} siendo lo frecuente el cifrado de contenido de forma que solo las \emph{aplicaciones autorizadas} tienen las claves y algoritmos necesarios para acceder a él.
En otros casos, es el propio sistema operativo quien se encarga de esta tarea, esto se encuentra generalmente en entornos cerrados donde no es posible ejecutar aplicaciones no autorizadas para acceder a la memoria RAM donde se encontraría la aplicación.\footnote{Este es el caso del sistema operativo iOS donde el cifrado de la aplicación la realiza el \textit{kernel}. Una vez se pudo ejecutar aplicaciones no firmadas, fue fácil descifrar el contenido de terceras aplicaciones leyendo la memoria RAM.}.

El principal problema es la posibilidad de aplicar métodos de \emph{ingeniería inversa} sobre el \textit{software} autorizado. Una vez conocido cómo una aplicación accede al contenido protegido, nada imposibilitar crear una versión que también lo permita.

\textbf{TODO INTRO}

En las siguientes secciones se analizará mecanismos de seguridad que diferentes juegos aplican sobre materiales con derechos de autor.
Se analizará en primer lugar dos videojuegos que incluyen uno o más libros electrónicos y a continuación otros que incluyen canciones.
El resultado en todos estos casos ha sido la carencia de cualquier mecanismo eficaz.

\section{Libros electrónicos}
\paragraph{Ninokuni y la Ira de la Bruja Blanca}~\\
El primero juego a tratar será \textit{Ninokuni y La Ira de la Bruja Blanca} desarrollado por \textit{Level-5} para \textit{Play Station 3} en el año 2011.
Se trata de una versión muy similar a la que salió dos años antes para la \textit{Nintendo DS} que incluía un libro físico imprescindible para el jugador.

Debido a los problemas de traducción y distribución de este libro, ese juego no salió de Japón.
En el caso de esta versión para \ac{PS3} y aprovechando las capacidades de una pantalla grande el libro de tradujo y se incluyó en el juego pudiendo acceder a él mediante un visor especial accesible desde un menú.
En la edición coleccionasta del juego si se daba una copia física en inglés.
El denominado \textit{Vademécum del mago} en la primera versión del juego nunca se llego a escanear siendo imposible de encontrarlo en Internet.
En cambio, debido a una gran falta de seguridad en su distribución digital, en pocos días se pudo acceder a los archivos del juego y realizar una sencilla conversión a PDF.

El libro digital se encuentra codificado en el archivo \textit{hd05\_es.sdat} dentro de la carpeta principal en formato \emph{PSAR} (común en juegos de \ac{PS3}).
Se trata de un fichero que contiene archivos comprimidos.
La compresión en este caso fue obvia pues en la posición \textsf{0x0C} se encuentra en ASCII la cadena de caracteres \textsf{zlib} (figura~\ref{fig:c4-psar}).
Además el fichero no presenta dificultad en su descifrado pues se basa como en la mayoría de su tipo en incluir después de la cabecera todas las posiciones y tamaños de los archivos que incluye (tabla~\ref{tab:c4-psar}).
En el repositorio de este trabajo se incluye un programa desarrollado para su descompresión.\footnote{\url{https://github.com/pleonex/Ninokuni/tree/master/Programs/PS3/NinoDecompiler}}.

\ctable[
    caption = Especificación de formato PSAR,
    label   = tab:c4-psar,
    pos     = h
]{ccl}{
    \tnote[a]{\textit{File Info Table}. Tabla con información genérica de los archivos.}
    \tnote[b] {Los archivos pueden estar comprimidos.}
    \tnote[c] {El primer archivo con código MD5 nulo contiene la lista de nombres y rutas de ficheros.}
}{                                                                      \FL
    Posición      & Tamaño        & Descripción                         \ML
    \textsf{0x00} & \textsf{0x04} & Identificador: \textsf{PSAR}        \NN
    \textsf{0x04} & \textsf{0x04} & Versión: \textsf{0x00010004}        \NN
    \textsf{0x08} & \textsf{0x04} & Compresión: \textsf{zlib}           \NN
    \textsf{0x0C} & \textsf{0x04} & Posición de los datos               \NN
    \textsf{0x10} & \textsf{0x04} & Tamaño del FIT\tmark[a]             \NN
    \textsf{0x14} & \textsf{0x04} & Número de archivos                  \NN
    \textsf{0x18} & \textsf{0x04} & Reservado                           \NN
    \textsf{0x1C} & \textsf{0x04} & Reservado                           \ML
    \multicolumn{3}{c}{FIT}                                             \NN
    \textsf{0x00} & \textsf{0x10} & Código MD5 del nombre del fichero   \NN
    \textsf{0x10} & \textsf{0x04} & Desconocido                         \NN
    \textsf{0x14} & \textsf{0x05} & Posición de los datos               \NN
    \textsf{0x19} & \textsf{0x05} & Tamaño de los datos                 \ML
    \multicolumn{3}{c}{Archivos\tmark[b]\tmark[c]}                      \LL
}

\includefigure{fig:c4-psar}%
{Primeros \textit{bytes} del fichero \emph{PSAR}.}%
{imgs/C4-PSAR.png}

Descomprimiendo el fichero se encuentran nueve archivos de los cuales destaca uno de 438 MB \textit{data/book/es/BigData/gdv.dat}.
Por su tamaño se intuye su contenido.
Su formato de nuevo fácil de analizar pues tras unas largas cabeceras, al inicio de los datos hay una cabecera con las siglas \emph{JPEG}.
A continuación en la figura~\ref{tab:c4-gvd} se muestra la especificación de este tipo de fichero que contiene cada una de las hojas del libro electrónico.


\ctable[
    caption = Especificación de formato GVD,
    label   = tab:c4-gvd,
    pos     = h
]{ccl}{
    \tnote[a]{Hay un bloque por página.}
    \tnote[b]{Relativo al inicio del bloque de datos.}
    \tnote[c]{La codificación del nombre es ASCII.}
    \tnote[d]{Hay un bloque por cada calidad.}
}{                                                                          \FL
    Posición      & Tamaño        & Descripción                             \ML
    \textsf{0x00} & \textsf{0x08} & Identificador: \textsf{TGDT0100}        \NN
    \textsf{0x08} & \textsf{0x04} & Número de páginas                       \NN
    \textsf{0x0C} & \textsf{0x04} & Posición de los datos                   \ML
    \multicolumn{3}{c}{Bloques GVD\tmark[a]}                                \NN
    \textsf{0x00} & \textsf{0x04} & Posición del nombre\tmark[b]\tmark[c]   \NN
    \textsf{0x04} & \textsf{0x04} & Tamaño del nombre                       \NN
    \textsf{0x08} & \textsf{0x04} & Posición de los datos\tmark[b]          \NN
    \textsf{0x0C} & \textsf{0x04} & Tamaño de los datos                     \ML
    \multicolumn{3}{c}{Información de la página}                            \NN
    \textsf{0x00} & \textsf{0x04} & Identificador bloque: \textsf{GVEW0100} \NN
    \textsf{0x04} & \textsf{0x04} & Identificador imagen: \textsf{JPEG0100} \NN
    \textsf{0x08} & \textsf{0x04} & Ancho de la imagen con más calidad      \NN
    \textsf{0x0C} & \textsf{0x04} & Alto de la imagen con más calidad       \NN
    \textsf{0x10} & \textsf{0x04} & Identificador: \textsf{BLK\_}           \NN
    \textsf{0x14} & \textsf{0x04} & Tamaño del bloque                       \NN
    \textsf{0x18} & \textsf{0x04} & ID                                      \NN
    \textsf{0x1C} & \textsf{0x04} & Reservado                               \NN
    \textsf{0x20} & \textsf{0x04} & Constante \textsf{0x20}                 \NN
    \textsf{0x24} & \textsf{0x04} & Constante \textsf{0x04}                 \ML
    \multicolumn{3}{c}{Datos de la página\tmark[d]}                         \NN
    \textsf{0x00} & \textsf{0x04} & Posición X de la imagen en la página    \NN
    \textsf{0x04} & \textsf{0x04} & Posición Y de la imagen en la página    \NN
    \textsf{0x08} & \textsf{0x04} & Calidad                                 \NN
    \textsf{0x0C} & \textsf{0x04} & Tamaño de los datos                     \NN
    \textsf{0x10} & \textsf{0x04} & Desconocido                             \NN
    \textsf{0x14} & \textsf{0x04} & Desconocido                             \NN
    \textsf{0x18} & \textsf{0x04} & Ancho                                   \NN
    \textsf{0x1C} & \textsf{0x04} & Alto                                    \NN
    \textsf{0x20} & Variable      & Datos                                   \LL
}

Como se aprecia, una página se compone de diferentes imágenes \textsf{JPEG} concatenadas.
Tras este análisis, desde el primer fichero directamente extraído de la carpeta del juego en formato \textsf{PSAR} hasta este que contiene cada una de las páginas en formato \textsf{GVD} no se ha apreciado ningún mecanismo que intente proteger o dificultar la tarea de extraer cada una de las páginas.
Incluso los formatos de las propias imágenes son estándar.

Cabe destacar también, que la \ac{PS3} provee de mecanismos nativos para cifrar archivos que sí se usa para proteger el resto de datos del juego como imágenes y textos (archivo \textit{hs06\_es.adat.sdat}).
Este formatos con extensión \textsf{sdat} y cabecera \textsf{NPD} usa las claves internas y mecanismos internos de cifrado de la consola que asegura su confidencialidad\footnote{Ha día de hoy ya se ha podido romper este mecanismo. \url{https://github.com/Hykem/make_npdata}}.
