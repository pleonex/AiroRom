% Copyright (c) 2015 Benito Palacios Sánchez - All Rights Reserved.
% Esta obra está licenciada bajo la Licencia Creative Commons Atribución 4.0
% Internacional. Para ver una copia de esta licencia, visita
% http://creativecommons.org/licenses/by/4.0/.

\chapter{Multijugador y contenido descargable}


\section{Multijugador}

\subsection{Conexión segura en servidores de Nintendo}

\subsection{Preguntados}

\section{Contenido descargable}

\subsection{100 Classic Books Collection}
\textit{100 Classic Books Collection} se trata de un juego que como se analizó en la sección~\ref{sec:cr-100-books} ofrece al usuario un lector de libros electrónicos. En esta sección se pudo observa como los ficheros no vienen protegidos de ninguna manera a parte de usar un formato diferente.

Este juego provee además de una opción de comunicación inalámbrica para descargar alrededor de 20 nuevos libros. Estos se almacenarían en el archivo de guardado del usuario. Tras analizar las comunicaciones usando la versión modificada de \textit{DeSmuME} anteriormente descrita se pudo observar que estos ficheros descargados tampoco estaban cifrados, teniendo el mismo formato que aquellos que se encuentran dentro del juego. % TODO: Verificar

A pesar de que todavía no se conoce públicamente de usuarios que hayan modificado o explotado este juego, el almacenar contenido no cifrado, sin mecanismos de integridad, dentro del archivo de la partida del usuario abre las puertas para tanto la extracción como editado (poder leer libros externos). Cabe recalcar que modificar una partida no es solo posible utilizando tarjetas \textit{flashcard} si no también directamente sobre el cartucho original usando \textit{hardware} extra.

Además, reproducir contenido desde un archivo de guardado y más teniendo en cuenta que este se añade mediante descarga externa es una vulnerabilidad en cuenta a la posibilidad de ejecutar código malicioso. Si se diese el caso de encontrar un fallo de seguridad en el código como puede ser un desbordamiento de buffer al insertar un texto muy largo, se podría ejecutar código no autorizado.

\subsubsection{Conclusión}
\begin{tabular}{p{0.4\textwidth}p{0.5\textwidth}}
Puntos fuertes & Puntos débiles \\
\begin{itemize}
\item Las comunicaciones inalámbricas nativamente van cifradas con HTTPS por lo que no se podría realizar un ataque de \textit{man-in-the-middle}.
\end{itemize} &

\begin{itemize}
\item Los archivos no van cifrados ni incorporan algún mecanismo de integridad que asegure que el contenido es el que proporcionado por el desarrollador.
\end{itemize} \\
\end{tabular}

\subsection{Ninokuni y El Mago de las Tinieblas}

\subsection{Duet}
Por último se verá el caso del juego \textit{Duet} para \textit{iOS} y sus niveles extras.
Se trata de una compra integrada en la aplicación por 0.99 euros que añade un nuevo conjunto de pruebas.
Analizando de nuevo el contenido de la carpeta centrándose en estos niveles, se averigua que estos están presentes en el juego y que mediante la compra se activan.
La búsqueda se centra por tanto en saber dónde se guarda la configuración del juego para ver si está protegida que como se verá no es así.

\includefigure{fig:mp-duet}%
{Filas de la base de datos de \textit{Duet} que activan el contenido extra.}%
{imgs/MP-Duet.png}

En la carpeta \textit{Documents} de la aplicación existen tres bases de datos \textit{sqlite}.
Abriendo la de mayor tamaño, \textit{persistent-data.db}, y gracias a su nombre que nos indica que hay datos persistentes, es decir, constantes en cada ejecución del juego nos encontramos las filas de la figura~\ref{fig:mp-duet}.
En ella se ve como los valores que activan el contenido extra, el contenido de pago, están puestos a \textsf{0}, el valor que corresponde a \textit{desactivado} por lo general.
Si se cambia a \textsf{1} y se inicia la aplicación de nuevo nos encontraremos con este contenido activado.

La protección ante este tipo de casos es tan sencilla como poner una contraseña a la base de datos.
Se trata de un mecanismo que está implementado nativamente\footnote{\url{http://web.archive.org/web/20070813071554/http://sqlite.phxsoftware.com/forums/t/130.aspx}} en las bibliotecas de \textit{sqlite} y muy sencillo de usar.
La contraseña se puede almacenar en texto plano en la aplicación, pues dificultará la tarea de conocerla y al valer el contenido tan poco (menos de 1 euro) no compensará el esfuerzo dedicado como se ha discutido en capítulos anteriores.

\section{Ejecutables firmados}
%http://problemkaputt.de/gbatek.htm#biosramusage
Si 0x27FFC40 está a 1 indica que se carga de la ROM, se supone segura y no se comprueba el HMAC de los archivos.
En download play hay otro valor y se comprueba, como se hace en ARM9 se puede omitir.
Parece que se introdujo en DSi.
Evitar codigo no seguro cambiado en un man-in-the-middle para hackear la DSi.
El arm9 se firma durante el envio pero los datos no.
%http://problemkaputt.de/gbatek.htm#dswifimultiboot
Una vez que se ha ejecutado un juego desde una flashcard, el arm9 se puede editar pues el RSA se genera al vuelo sobre lo que hay y habria que cambiar el código de los overlays guardado en el arm9 o deshabilitar el flag de la tabla de overlays.
